---
last_mapped: 2026-02-18T12:20:00Z
total_files: 38
total_tokens: ~60000
---

# ngbot Codebase Map

> Auto-generated by Cartographer. Last mapped: 2026-02-18

## System Overview

**ngbot** is a Telegram chat gatekeeper bot that protects groups from spam and automated bot joins. It provides CAPTCHA-based entry verification, LLM-powered spam detection, and community voting moderation.

```mermaid
graph TB
    subgraph Entry
        Main[cmd/ngbot/main.go]
    end

    subgraph Core
        Service[bot/service.go]
        Processor[bot/update_processor.go]
        Config[config/config.go]
    end

    subgraph Handlers
        Admin[handlers/admin]
        Gatekeeper[handlers/chat/gatekeeper.go]
        Reactor[handlers/chat/reactor.go]
        Moderation[handlers/moderation]
    end

    subgraph Adapters
        LLM[adapters/llm.go]
        Gemini[adapters/llm/gemini]
        OpenAI[adapters/llm/openai]
    end

    subgraph Data
        SQLite[db/sqlite/client.go]
        Entities[db/entities.go]
        Migrations[resources/migrations]
    end

    subgraph Resources
        I18N[i18n/i18n.go]
        Translations[resources/i18n/translations.yml]
        Challenges[resources/gatekeeper/challenges]
    end

    Main --> Service
    Main --> Processor
    Main --> Config

    Processor --> Admin
    Processor --> Gatekeeper
    Processor --> Reactor

    Admin --> Service
    Gatekeeper --> Service
    Reactor --> Moderation
    Reactor --> LLM

    Moderation --> LLM
    LLM --> Gemini
    LLM --> OpenAI

    Service --> SQLite
    SQLite --> Entities
    SQLite --> Migrations

    Gatekeeper --> I18N
    Admin --> I18N
    I18N --> Translations
    Gatekeeper --> Challenges
```

## Directory Structure

```
ngbot/
â”œâ”€â”€ cmd/ngbot/main.go           # Application entry point
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ bot/                    # Core bot service and update processing
â”‚   â”‚   â”œâ”€â”€ service.go          # Membership tracking, settings, caching
â”‚   â”‚   â”œâ”€â”€ update_processor.go # Update dispatch, handler registry
â”‚   â”‚   â””â”€â”€ dependencies.go     # Interface definitions
â”‚   â”œâ”€â”€ config/                 # Configuration loading (env vars)
â”‚   â”‚   â”œâ”€â”€ config.go           # NG_* environment variables
â”‚   â”‚   â””â”€â”€ log_formatter.go    # Custom logrus formatter
â”‚   â”œâ”€â”€ db/                     # Database layer
â”‚   â”‚   â”œâ”€â”€ sqlite/client.go    # SQLite implementation
â”‚   â”‚   â”œâ”€â”€ sqlite/admin_panel.go
â”‚   â”‚   â”œâ”€â”€ entities.go         # Data structures
â”‚   â”‚   â””â”€â”€ dependencies.go     # Client interface
â”‚   â”œâ”€â”€ adapters/               # External service adapters
â”‚   â”‚   â”œâ”€â”€ llm.go              # LLM interface
â”‚   â”‚   â””â”€â”€ llm/
â”‚   â”‚       â”œâ”€â”€ entities.go     # Chat completion types
â”‚   â”‚       â”œâ”€â”€ gemini/         # Google Gemini adapter
â”‚   â”‚       â””â”€â”€ openai/         # OpenAI-compatible adapter
â”‚   â”œâ”€â”€ handlers/               # Update handlers (chain of responsibility)
â”‚   â”‚   â”œâ”€â”€ admin/              # Admin commands and panel
â”‚   â”‚   â”œâ”€â”€ chat/               # Gatekeeper, Reactor
â”‚   â”‚   â”œâ”€â”€ moderation/         # Spam detection, ban service
â”‚   â”‚   â””â”€â”€ base/               # Shared handler utilities
â”‚   â”œâ”€â”€ i18n/                   # Internationalization
â”‚   â”‚   â”œâ”€â”€ i18n.go             # Translation loading/lookup
â”‚   â”‚   â””â”€â”€ languages.go        # Language name lookup
â”‚   â””â”€â”€ infra/                  # Infrastructure utilities
â”‚       â”œâ”€â”€ filesystem.go       # Working directory management
â”‚       â””â”€â”€ health_check.go     # Executable monitoring
â”œâ”€â”€ resources/
â”‚   â”œâ”€â”€ embed.go                # Go embed directive
â”‚   â”œâ”€â”€ i18n/translations.yml   # 30 language translations
â”‚   â”œâ”€â”€ gatekeeper/challenges/  # Per-language emoji challenges
â”‚   â””â”€â”€ migrations/             # SQL migration files
â”œâ”€â”€ go.mod                      # Dependencies
â”œâ”€â”€ Dockerfile                  # Multi-stage build
â”œâ”€â”€ compose.yaml                # Docker Compose config
â””â”€â”€ .env.example                # Configuration template
```

## Module Guide

### Core Bot Module (`internal/bot/`)

**Purpose**: Central bot service and update processing pipeline

| File | Purpose | Key Exports |
|------|---------|-------------|
| `service.go` | Membership/settings management with caching | `NewService()`, `IsMember()`, `GetSettings()` |
| `update_processor.go` | Update dispatch to handlers | `UpdateProcessor`, `RegisterUpdateHandler()` |
| `dependencies.go` | Interface contracts | `Service`, `Handler` |

**Key Patterns**:
- Two-level caching (members: 5-min TTL, settings: no expiry)
- Handler registry with chain of responsibility
- Update timeout: 5 minutes (stale updates dropped)

**Dependencies**: `telegram-bot-api`, `db`, `config`

---

### Handlers Module (`internal/handlers/`)

**Purpose**: Update processing chain with specialized handlers

| Handler | Purpose | Chain Order |
|---------|---------|-------------|
| `Admin` | `/lang`, `/settings`, admin panel | 1 (stops on match) |
| `Gatekeeper` | CAPTCHA challenges for new members | 2 (stops for callbacks) |
| `Reactor` | Spam detection, message processing | 3 (always runs) |

**Key Files**:

| File | Purpose | Lines |
|------|---------|-------|
| `chat/gatekeeper.go` | CAPTCHA challenge flow | 845 |
| `chat/reactor.go` | Message processing pipeline | 822 |
| `admin/panel_handler.go` | Admin panel callbacks | 819 |
| `moderation/ban_service.go` | Ban management, lols.bot API | 401 |
| `moderation/spam_control.go` | Voting system | 397 |
| `moderation/spam_detector.go` | LLM-based detection | 245 |

**Dependencies**: `bot`, `db`, `adapters/llm`, `i18n`, `config`

---

### Database Module (`internal/db/`)

**Purpose**: SQLite persistence with repository pattern

| File | Purpose |
|------|---------|
| `sqlite/client.go` | Thread-safe SQLite client |
| `sqlite/admin_panel.go` | Admin panel session storage |
| `entities.go` | Data structures with `db` tags |
| `dependencies.go` | `Client` interface |

**Key Entities**:
| Entity | Purpose |
|--------|---------|
| `Settings` | Per-chat configuration |
| `Challenge` | CAPTCHA state |
| `SpamCase` | Spam report with voting |
| `AdminPanelSession` | Admin UI state |

**Gotchas**:
- Returns `nil, nil` for "not found" (no error)
- `SpamVote.Vote`: `true` = NOT spam (inverted)
- Connection pool: 42 max open connections

---

### LLM Adapters (`internal/adapters/llm/`)

**Purpose**: Abstraction over OpenAI and Google Gemini APIs

```go
type LLM interface {
    ChatCompletion(ctx, messages) (Response, error)
}
```

| Adapter | Default Model | Notes |
|---------|---------------|-------|
| `gemini.API` | `gemini-2.5-flash-lite` | Uses `google.golang.org/genai` with fixed `BLOCK_NONE` safety thresholds |
| `openai.API` | `gpt-4o-mini` | Supports custom base URL |

**Gotchas**:
- Gemini: roles are mapped explicitly (`assistant` -> `model`) before request
- Gemini: safety policy is always `BLOCK_NONE` for supported text categories

---

### i18n Module (`internal/i18n/`)

**Purpose**: Multi-language support for bot messages

| File | Purpose |
|------|---------|
| `i18n.go` | Translation loading/lookup |
| `languages.go` | ISO code to name mapping |

**Supported Languages**: be, bg, cs, da, de, el, en, es, et, fi, fr, hu, id, it, ja, ko, lt, lv, nb, nl, pl, pt, ro, ru, sk, sl, sv, tr, uk, zh (30 total)

**Pattern**: English keys as source, fallback to key if no translation

---

## Data Flow

### Telegram Update Processing

```mermaid
sequenceDiagram
    participant TG as Telegram
    participant UP as UpdateProcessor
    participant Admin as Admin Handler
    participant GK as Gatekeeper
    participant Reactor as Reactor

    TG->>UP: Update received
    UP->>UP: Check age (< 5 min)

    alt Update too old
        UP->>UP: Drop update
    else Valid update
        UP->>Admin: Handle()

        alt Admin handled
            Admin-->>UP: proceed=false
        else No admin action
            Admin-->>UP: proceed=true
            UP->>GK: Handle()

            alt Gatekeeper handled
                GK-->>UP: proceed=false
            else No gatekeeper action
                GK-->>UP: proceed=true
                UP->>Reactor: Handle()
                Reactor-->>UP: proceed=true
            end
        end
    end
```

### Gatekeeper Challenge Flow

```mermaid
sequenceDiagram
    participant User
    participant Group
    participant Gatekeeper
    participant DB

    User->>Group: Joins group
    Group->>Gatekeeper: NewChatMembers update
    Gatekeeper->>Gatekeeper: Restrict user
    Gatekeeper->>DB: Create challenge
    Gatekeeper->>Group: Send CAPTCHA buttons

    User->>Gatekeeper: Click button
    Gatekeeper->>DB: Get challenge

    alt Correct answer
        Gatekeeper->>Group: Unrestrict user
        Gatekeeper->>Group: Delete challenge message
        Gatekeeper->>DB: Delete challenge
    else Wrong answer
        Gatekeeper->>Group: Ban user (temp)
        Gatekeeper->>Group: Delete messages
        Gatekeeper->>DB: Delete challenge
    end
```

### Spam Detection Flow

```mermaid
sequenceDiagram
    participant User
    participant Reactor
    participant LLM
    participant SpamControl
    participant DB

    User->>Reactor: Send message
    Reactor->>DB: Check membership

    alt Not a member
        Reactor->>Reactor: Extract content
        Reactor->>LLM: IsSpam(content, examples)

        alt LLM says spam
            LLM-->>Reactor: true
            Reactor->>SpamControl: ProcessSpamMessage()
            SpamControl->>DB: Create SpamCase
            SpamControl->>User: Mute (10 min)
            SpamControl->>User: Send voting notification
        else Not spam
            LLM-->>Reactor: false
            Reactor->>DB: InsertMember()
        end
    end
```

## Configuration

### Environment Variables (NG_* prefix)

| Variable | Default | Description |
|----------|---------|-------------|
| `NG_TOKEN` | *required* | Telegram bot token |
| `NG_LANG` | `en` | Default language |
| `NG_HANDLERS` | `admin,gatekeeper,reactor` | Enabled handlers |
| `NG_LOG_LEVEL` | `2` | Log verbosity (0-6) |
| `NG_DOT_PATH` | `~/.ngbot` | Data directory |
| `NG_LLM_API_KEY` | *required* | LLM API key |
| `NG_LLM_API_MODEL` | `gpt-4o-mini` | Model name |
| `NG_LLM_API_URL` | `https://api.openai.com/v1` | OpenAI-compatible API endpoint (used when `NG_LLM_API_TYPE=openai`) |
| `NG_LLM_API_TYPE` | `openai` | Provider (openai/gemini) |
| `NG_FLAGGED_EMOJIS` | `ðŸ‘Ž,ðŸ’©` | Reaction ban triggers |
| `NG_SPAM_MIN_VOTERS` | `2` | Min votes for action |
| `NG_SPAM_MAX_VOTERS` | `10` | Max voters |
| `NG_SPAM_MIN_VOTERS_PERCENTAGE` | `5` | Vote threshold % |
| `NG_SPAM_VOTING_TIMEOUT` | `5m` | Voting window |

## Conventions

### Go Code Style
- Go 1.25+ with modern tooling
- Self-documenting code (minimal comments)
- `gofumpt` formatting
- `any` instead of `interface{}`
- Context as first parameter

### Architecture
- Hexagonal/DDD structure
- Interface-based dependency injection
- Repository pattern for database
- Handler chain of responsibility

### Database
- SQLite with embedded migrations
- `db:` struct tags for sqlx
- Mutex-protected operations

## Gotchas

1. **Handler chain order matters**: Admin â†’ Gatekeeper â†’ Reactor
2. **SpamVote.Vote is inverted**: `true` = NOT spam, `false` = IS spam
3. **LLM provider initialization failure stops startup**: Bot exits with explicit init error
4. **Update timeout is 5 minutes**: Old updates silently dropped
5. **Cyrillic normalization**: Used to detect homoglyph spam attacks
6. **External banlist**: Uses lols.bot API for known spammer database
7. **Gatekeeper uses lols.bot**: External API for ban checking
8. **Session TTL**: Admin panel sessions expire after 1 hour

## Navigation Guide

### To add a new handler
1. Create package in `internal/handlers/<name>/`
2. Implement `bot.Handler` interface
3. Register in `cmd/ngbot/main.go`: `bot.RegisterUpdateHandler("name", handler)`
4. Add to `NG_HANDLERS` env var

### To add a new LLM provider
1. Create package in `internal/adapters/llm/<provider>/`
2. Implement `adapters.LLM` interface
3. Add factory case in `cmd/ngbot/main.go` `configureLLM()`
4. Add `NG_LLM_API_TYPE` option

### To add new translations
1. Add entries to `resources/i18n/translations.yml`
2. Add challenge file in `resources/gatekeeper/challenges/<lang>.yml`
3. Add language name in `internal/i18n/languages.go`

### To modify spam detection
1. **Examples**: Edit `internal/handlers/moderation/spam_detector.go` few-shot examples
2. **Logic**: Modify `Reactor.handleMessage()` pipeline stages
3. **Voting**: Adjust `internal/handlers/moderation/spam_control.go`

### To add database tables
1. Create migration in `resources/migrations/YYYYMMDDHHMMSS-description.sql`
2. Add entity to `internal/db/entities.go`
3. Add methods to `internal/db/dependencies.go` interface
4. Implement in `internal/db/sqlite/client.go`

## Dependencies

| Package | Purpose |
|---------|---------|
| `github.com/OvyFlash/telegram-bot-api` | Telegram Bot API |
| `github.com/sashabaranov/go-openai` | OpenAI client |
| `google.golang.org/genai` | Gemini client |
| `modernc.org/sqlite` | Pure-Go SQLite |
| `github.com/jmoiron/sqlx` | SQL extensions |
| `github.com/rubenv/sql-migrate` | Migrations |
| `github.com/sirupsen/logrus` | Logging |
| `github.com/sethvargo/go-envconfig` | Env config |
| `gopkg.in/yaml.v2` | YAML parsing |
